<!doctype html>
<html>
<head>
<title>One tab p2p</title>

<style type="text/css">
    video { width: 240px; height: 160px; border: black 1px solid;}
</style>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script>
var isOwrWebKit = !!navigator.mediaDevices && !!self.webkitAudioPannerNode;
var isFirefox = window.mozRTCPeerConnection && !window.webkitRTCPeerConnection;
if (isFirefox) {
    window.webkitURL = window.URL;
    navigator.webkitGetUserMedia = navigator.mozGetUserMedia;
    window.webkitRTCPeerConnection = window.mozRTCPeerConnection;
    window.RTCSessionDescription = window.mozRTCSessionDescription;
    window.RTCIceCandidate = window.mozRTCIceCandidate;
}

var closeButton;
var pc1;
var pc2;
var localStream;

var configuration = { "iceServers": [{ "urls": "stun:mmt-stun.verkstad.net" }] };

if (isOwrWebKit) {
    webkitRTCPeerConnection.prototype.addStream = function (stream) {
        this.addTrack(stream.getTracks()[0], stream);
    }

    // FXME: handle JSON stringifying this natively
    RTCSessionDescription.prototype.toJSON = function () {
        return {
            "type": this.type,
            "sdp": this.sdp
        };
    }

    RTCIceCandidate.prototype.toJSON = function () {
        return {
            "candidate": this.candidate,
            "sdpMid": this.sdpMid,
            "sdpMLineIndex": this.sdpMLineIndex
        };
    }
}

window.onload = function () {
    var startButton = document.getElementById("start_but");
    closeButton = document.getElementById("close_but");
    var testButtons = {
        "single": document.getElementById("single_but"),
        "media1to2": document.getElementById("media_1_2_but"),
        "media2to1": document.getElementById("media_2_1_but"),
        "singlePromise": document.getElementById("single_promise_but")
    };
    var audioCheckBox = document.getElementById("audio_cb");
    var videoCheckBox = document.getElementById("video_cb");

    startButton.disabled = !navigator.webkitGetUserMedia;
    startButton.onclick = function () {
        audioCheckBox.disabled = videoCheckBox.disabled = true;
        // get a local stream
        navigator.webkitGetUserMedia({ "audio": audioCheckBox.checked,
            "video": videoCheckBox.checked }, function (stream) {
            localStream = stream;

            startButton.disabled = true;
            setTestButtonsDisabled(false);
        }, logError);
    };

    closeButton.onclick = function (evt) {
        evt.target.disabled = true;
        console.log("closing");
        pc1.close();
        pc2.close();
        pc1 = null;
        pc2 = null;

        setTestButtonsDisabled(false);
    }

    testButtons.single.onclick = function (evt) {
        setTestButtonsDisabled(true);
        single();
    }

    testButtons.media1to2.onclick = function (evt) {
        setTestButtonsDisabled(true);
        media1to2(testButtons.media2to1);
    }

    testButtons.media2to1.onclick = function (evt) {
        setTestButtonsDisabled(true);
        media2to1(testButtons.media1to2);
    }

    testButtons.singlePromise.onclick = function (evt) {
        setTestButtonsDisabled(true);
        singlePromise();
    }

    function setTestButtonsDisabled(isDisabled) {
        for (var p in testButtons)
            testButtons[p].disabled = isDisabled;
    }
}

function single() {
    commonSetup();

    renderStream(localStream, document.querySelector("#self_view1"));
    pc1.addStream(localStream);

    pc1.createOffer(function (offer) {
        pc1.setLocalDescription(offer, function () {
            offerToPc2(pc1.localDescription);
        }, logError);
    }, logError);

    function offerToPc2(offer) {
        pc2.setRemoteDescription(offer, function () {
            renderStream(localStream, document.querySelector("#self_view2"));
            pc2.addStream(localStream);

            pc2.createAnswer(function (answer) {
                pc2.setLocalDescription(answer, function () {
                    answerToPc1(pc2.localDescription);
                }, logError);
            }, logError);
        }, logError);
    }

    function answerToPc1(answer) {
        pc1.setRemoteDescription(answer, function () {
            console.log("initiator got answer, O/A dialog completed");
            closeButton.disabled = false;
        }, logError);
    }
}

function media1to2(continueButton) {
    if (!pc1)
        commonSetup();

    renderStream(localStream, document.querySelector("#self_view1"));
    pc1.addStream(localStream);

    aStep(pc1, pc2, continueButton)
}

function media2to1(continueButton) {
    if (!pc1)
        commonSetup();

    renderStream(localStream, document.querySelector("#self_view2"));
    pc2.addStream(localStream);

    aStep(pc2, pc1, continueButton)
}

function aStep(pcA, pcB, continueButton) {
    pcA.createOffer(function (offer) {
        pcA.setLocalDescription(offer, function () {
            offerToPcB(pcA.localDescription);
        }, logError);
    }, logError);

    function offerToPcB(offer) {
        pcB.setRemoteDescription(offer, function () {
            pcB.createAnswer(function (answer) {
                pcB.setLocalDescription(answer, function () {
                    answerToPcA(pcB.localDescription);
                }, logError);
            }, logError);
        }, logError);
    }

    function answerToPcA(answer) {
        pcA.setRemoteDescription(answer, function () {
            console.log("initiator got answer, single way O/A dialog completed");
            continueButton.disabled = false;
            closeButton.disabled = false;
        }, logError);
    }
}

function singlePromise() {
    console.log("-> singlePromise()");
    commonSetup();
    var track = localStream.getVideoTracks()[0];

    renderStream(localStream, document.querySelector("#self_view1"));
    pc1.addTrack(track, localStream);

    pc1.createOffer().then(function (offer) {
        return pc1.setLocalDescription(offer);
    })
    .then(function () {
        return pc2.setRemoteDescription(pc1.localDescription);
    })
    .then(function () {
        renderStream(localStream, document.querySelector("#self_view2"));
        pc2.addTrack(track, localStream);
        return pc2.createAnswer();
    })
    .then(function (answer) {
        return pc2.setLocalDescription(answer);
    })
    .then(function () {
        return pc1.setRemoteDescription(pc2.localDescription);
    })
    .then(function () {
        console.log("initiator got answer, O/A dialog completed");
        closeButton.disabled = false;
    })
    .catch(logError);
}

function commonSetup() {
    pc1 = new webkitRTCPeerConnection(configuration);
    pc2 = new webkitRTCPeerConnection(configuration);

    symetricSetup(pc1, "1", pc2);
    symetricSetup(pc2, "2", pc1);
}

function symetricSetup(pc, num, other) {
    pc.onicecandidate = function (evt) {
        if (evt.candidate) {
            logSignalling(evt.candidate, "pc" + num + ": outgoing");
            other.addIceCandidate(evt.candidate);
        }
    };

    pc.onaddstream = function (evt) {
        console.log("pc" + num + " got remote stream");
        renderStream(evt.stream, document.querySelector("#remote_view" + num));
    };

    pc.ontrack = function (evt) {
        console.log("pc" + num + " got remote track");
        evt.track.onunmute = function (evt) {
            var track = evt.target
            var stream = new MediaStream([track]);
            renderStream(stream, document.querySelector("#remote_view" + num));
        };
    }
}

function logError(error) {
    if (error) {
        if (error.name || error.message)
            log((error.name || "-") + ": " + (error.message || "-"));
        else
            log(error);
    } else
        log("Error (no error message)");
}

function logSignalling(msg, tag) {
    if (msg.candidate)
        log("=== " + tag + " candidate === (" + msg.candidate + ")");
    else if (msg.sdp) {
        log("=== " + tag + " " + msg.type + " ===");
        msg.sdp.split("\n").forEach(log);
        log("===");
    }
}

function renderStream(stream, video) {
    if (typeof video.srcObject != "undefined")
        video.srcObject = stream;
    else
        video.src = URL.createObjectURL(stream);
}

function log(msg) {
    log.div = log.div || document.getElementById("log_div");
    log.div.appendChild(document.createTextNode(msg));
    log.div.appendChild(document.createElement("br"));
}

</script>

</head>
<body>
<h3>One tab p2p - Test different signaling schemas</h3>
<input type="checkbox" id="audio_cb">Audio<br>
<input type="checkbox" id="video_cb" checked>Video<br>
<input type="button" id="start_but" value="Start">
<input type="button" id="close_but" value="Close Connections" disabled>
<br>
<input type="button" id="single_but" value="Single SDP dialog" disabled>
<input type="button" id="media_1_2_but" value="Media 1 to 2" disabled>
<input type="button" id="media_2_1_but" value="Media 2 to 1" disabled>
<br>
<input type="button" id="single_promise_but" value="Single SDP dialog (promise API)" disabled>
<br>

<p>pc1 local/remote</p>
<video id="self_view1" autoplay muted></video>
<video id="remote_view1" autoplay></video>
<br>
<p>pc2 local/remote</p>
<video id="self_view2" autoplay muted></video>
<video id="remote_view2" autoplay></video>

<div id="log_div"></div>
</body>
</html>
